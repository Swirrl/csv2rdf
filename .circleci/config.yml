# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  test:
    docker:
      - image: cimg/clojure:1.10
        auth:
          username: $DOCKERHUB_USERNAME # can specify string literal values
          password: $DOCKERHUB_PASSWORD # or project environment variable reference
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run:
          name: Test
          command: "clojure -T:build test"
      - store_test_results:
          path: test-results

  deploy-jar:
    docker:
      - image: cimg/clojure:1.10
        auth:
          username: $DOCKERHUB_USERNAME # can specify string literal values
          password: $DOCKERHUB_PASSWORD # or project environment variable reference
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run:
          name: Build
          command: clojure -T:build build-lib
      - run:
          name: Deploy
          command: |
            if [ -n "${CIRCLE_TAG}" ]; then
               clojure -T:build deploy
            else
               /bin/echo "Not deploying, not a tagged commit"
            fi

  deploy-graal-binary:
    docker:
      - image: cimg/clojure:1.10
    steps:
      - checkout
      # This doesn't change between deploys, so we could speed this up by
      # using a custom image based on cimg/clojure which includes graalvm.
      # However it doesn't take long, so this is probably fine for now.
      - run:
          name: Install graalvm
          command: |
            wget https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.1/graalvm-ce-java17-linux-amd64-22.3.1.tar.gz
            tar -xzf graalvm-ce-java17-linux-amd64-22.3.1.tar.gz
            graalvm-ce-java17-22.3.1/bin/gu install native-image
      - run:
          name: Build
          command: bin/compile
          environment:
            GRAALVM_HOME: graalvm-ce-java17-22.3.1
      - run:
          name: Publish
          command: |
            curl \
              -H 'Accept: application/vnd.github+json' \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/repos/swirrl/csv2rdf/releases \
              -d '{
                "tag_name": "'"${CIRCLE_TAG}"'",
                "generate_release_notes": true
              }'

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build-workflow:
    jobs:
      - test:
          context:
            - swirrl-dockerhub-consumer
          filters:
            tags:
              only: /.*/
      - deploy-jar:
          context:
            - swirrl-dockerhub-consumer
            - swirrl-clojars-publisher
          requires:
            - test
          filters:
            tags:
              only: /.*/
      - deploy-graal-binary:
          context:
            - swirrl-dockerhub-consumer
            - github-publish-releases
          requires:
            - test
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/
